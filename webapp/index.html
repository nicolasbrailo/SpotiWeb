<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Sp</title>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="webapp/style.css">

<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" charset="utf-8">

const HISTORY_CNT_LAST_ARTS_PLAYED = 10;
var collection = null;

function buildGenreHref(gen) {
  return gen.replace(' ', '-');
}

function buildGenres() {
  var items = [];
  $.each(collection.genres, (_, gen) => {
    items.push(`<li><a href="#${buildGenreHref(gen)}">${gen}</a></li>`);
  });
  return items.join('');
}

function buildSingleArt(art) {
  const art_info = collection.artists[art];
  if (!art_info) {
    return `<li><img src="https://en.wikipedia.org/wiki/Nyan_Cat#/media/File:Nyan_cat_250px_frame.PNG"/>${art}</li>`;
  } else {
    return `<li><a href='${art_info.uri}' onclick='on_art_clicked("${art}")'><img src='${art_info.img}'/>${art}</a></li>`;
  }
}

function buildArts() {
  var everything = [];
  $.each(collection.genres, (_, gen) => {
    var artlist = [];
    $.each(collection.artists_by_genre[gen], (_, art) => artlist.push(buildSingleArt(art)) );
    everything.push(`<h2 id='${buildGenreHref(gen)}'>${gen}</h2>
                     <ul class='arts'>${artlist.join('')}</ul>`);
  });
  return everything.join('');
}

function getRecentlyPlayed() {
  var lastPlayed;
  try {
    lastPlayed = JSON.parse(localStorage.getItem('lastPlayed'));
  } catch (e) {
    // Ignore
  } finally {
    if (!Array.isArray(lastPlayed)) lastPlayed = [];
  }

  return lastPlayed;
}

function buildRecentlyPlayed() {
  const lastPlayed = getRecentlyPlayed();
  if (lastPlayed.length == 0) return '';
  var arts = [];
  $.each(lastPlayed, (_, art) => arts.push(buildSingleArt(art)) );

  return `<h2>Recently played</h2><ul class='arts'>${arts.join('')}</ul>`;
}

function rebuildRecentlyPlayed() {
  $('#recently_played').html(buildRecentlyPlayed());
}

function on_art_clicked(art) {
  const lastPlayed = getRecentlyPlayed();
  var newLastPlayed = [];
  $.each(lastPlayed, (_,a) => {
    if (a != art) newLastPlayed.push(a);
  });
  newLastPlayed.push(art);

  if (newLastPlayed.length > HISTORY_CNT_LAST_ARTS_PLAYED) {
    newLastPlayed = newLastPlayed.slice(1, HISTORY_CNT_LAST_ARTS_PLAYED+1);
  }

  localStorage.setItem('lastPlayed', JSON.stringify(newLastPlayed));
  rebuildRecentlyPlayed();
}

function on_collection_loaded(col) {
  col.genres.sort();
  collection = col;
  $('#genres_idx').html(buildGenres())
  $('#arts_by_gen').html(buildArts());
  rebuildRecentlyPlayed();
}

$.ajax({
  type: 'GET',
  dataType: 'json',
  url: "/api/fetch_all",
  success: on_collection_loaded,
});
</script>

</head>
<body>

<div id="recently_played">
</div>

<h2>Genres index</h2>
<ul id="genres_idx" class='idx'>
</ul>

<div id="arts_by_gen">
</div>

<a href="/api/refresh">Refresh index</a>
</body>
</html>
